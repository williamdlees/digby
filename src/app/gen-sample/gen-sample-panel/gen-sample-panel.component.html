<div class="row">
  <div  class="spinner-border" role="status" *ngIf="dataSource.loading$ | async">
    <span class="sr-only">Loading...</span>
  </div>

  <div class="alert alert-danger" *ngIf="dataSource.error$ | async">
    <div class="row">
      <h4>Error loading table</h4>
      <p>{{dataSource.error$ | async}}</p>
    </div>
  </div>
</div>

<div class="row">
  <div class="col-auto" style="align-items: center; justify-content: flex-start; display: flex;">
    <span class="header-text">Quick search:&nbsp;</span>
    <input class="searchBox" #searchBox>
  </div>

  <div class="col-auto" style="align-items: center; justify-content: flex-start; display: flex; padding-left: 0px !important;">
    <button style="border-width: 0px; background-color: transparent;" (click)="clearSelection()">
      <mat-icon class="primary-icon"  style="">delete_sweep</mat-icon>
      <span class="header-text">Clear filters</span>
    </button>
  </div>

  <div class="col-auto" style="align-items: center; justify-content: flex-start; display: flex; padding-left: 0px !important;">
    <button digby-table-column-sorter
       [(columns)]="displayedColumns"
       [columnInfo]="allColumns"
       [saveName]="'gen-sample-table'"
       (columnsChange)="updateColumnData($event)" id="colbutton">
       <mat-icon class="primary-icon"  style="padding-left: 0px !important;">view_column</mat-icon>
    </button>
      <label class="form-check-label" for="colbutton">Arrange Columns</label>
  </div>

  <div class="col-auto" style="align-items: center; justify-content: flex-start; display: flex; padding-left: 0px !important;">
    <button style="border-width: 0px; background-color: transparent;" [matMenuTriggerFor]="downloadMenu" id="downloadbutton">
      <mat-icon class="primary-icon"  style="">cloud_download</mat-icon>
    </button>
    <label class="form-check-label" for="downloadbutton">Download</label>
  </div>

  <div class="col-auto" style="align-items: center; justify-content: flex-start; display: flex;" *ngIf="selectedSequenceNames.length">
    <div class="form-check">
      <input class="form-check-input" type="checkbox" id="chk-selected-items" style="margin-top: .1rem;"
        [(ngModel)]="isSelectedSamplesChecked"
        (change)="(onSelectedSamplesChange())"
      >
      <label class="form-check-label" for="chk-selected-items">
        Only records with selected genes
      </label>
    </div>
  </div>

  <div class="col-auto ml-auto">
    <mat-paginator [length]="dataSource?.totalItems" [pageSize]="25" [pageSizeOptions]="[25, 50, 100, 250]"></mat-paginator>
  </div>
</div>

<div class="row">
  <div class="col">
    <mat-table [dataSource]="dataSource">
       // Subject
       <ng-container matColumnDef="identifier">
          <mat-header-cell *matHeaderCellDef mwlResizable [enableGhostResize]="true" (resizeEnd)="onResizeEnd($event, 'identifier')"
     [resizeEdges]="{bottom: false, right: true, top: false, left: true}">
            Subject
           <app-filter #filterComponent="menuInOtherComponent" [columnName]="'identifier'" [filterMode]="filterModeEnum.TEXT_MODE" [setFilter$] = "setFilter$" [clear$] = "clear$" [choices$]="dataSource.choices$" (predicateEmitter)="applyFilter($event)"></app-filter>
          </mat-header-cell>
         <mat-cell *matCellDef="let sample"  (click)="showInfo(sample)"><b>{{sample.identifier}}</b></mat-cell>
      </ng-container>

       <ng-container matColumnDef="name_in_study">
          <mat-header-cell *matHeaderCellDef mwlResizable [enableGhostResize]="true" (resizeEnd)="onResizeEnd($event, 'name_in_study')"
     [resizeEdges]="{bottom: false, right: true, top: false, left: true}">
            Name in Study
           <app-filter #filterComponent="menuInOtherComponent" [columnName]="'name_in_study'" [filterMode]="filterModeEnum.TEXT_MODE" [clear$] = "clear$" [choices$]="dataSource.choices$" (predicateEmitter)="applyFilter($event)"></app-filter>
          </mat-header-cell>
          <mat-cell *matCellDef="let sample"  (click)="showInfo(sample)">{{sample.name_in_study}}</mat-cell>
      </ng-container>

       <ng-container matColumnDef="age">
          <mat-header-cell *matHeaderCellDef mwlResizable class="small-col" [enableGhostResize]="true" (resizeEnd)="onResizeEnd($event, 'age')"
     [resizeEdges]="{bottom: false, right: true, top: false, left: true}">
            Age
           <app-filter #filterComponent="menuInOtherComponent" [columnName]="'age'" [filterMode]="filterModeEnum.NUMBER_MODE" [clear$] = "clear$" [choices$]="dataSource.choices$" (predicateEmitter)="applyFilter($event)"></app-filter>
          </mat-header-cell>
          <mat-cell *matCellDef="let sample"  class="small-col" (click)="showInfo(sample)">{{sample.age}}</mat-cell>
      </ng-container>

       <ng-container matColumnDef="sex">
          <mat-header-cell *matHeaderCellDef mwlResizable [enableGhostResize]="true" (resizeEnd)="onResizeEnd($event, 'sex')"
     [resizeEdges]="{bottom: false, right: true, top: false, left: true}">
            Sex
           <app-filter #filterComponent="menuInOtherComponent" [columnName]="'sex'" [filterMode]="filterModeEnum.TEXT_MODE" [clear$] = "clear$" [choices$]="dataSource.choices$" (predicateEmitter)="applyFilter($event)"></app-filter>
          </mat-header-cell>
          <mat-cell *matCellDef="let sample"  (click)="showInfo(sample)">{{sample.sex}}</mat-cell>
      </ng-container>

       <ng-container matColumnDef="annotation_path">
          <mat-header-cell *matHeaderCellDef mwlResizable class="small-col" [enableGhostResize]="true" (resizeEnd)="onResizeEnd($event, 'annotation_path')"
     [resizeEdges]="{bottom: false, right: true, top: false, left: true}">
            Report
           <app-filter #filterComponent="menuInOtherComponent" [columnName]="'annotation_path'" [filterMode]="filterModeEnum.TEXT_MODE" [clear$] = "clear$" [choices$]="dataSource.choices$" (predicateEmitter)="applyFilter($event)"></app-filter>
          </mat-header-cell>
          <mat-cell *matCellDef="let sample" class="small-col">
            <ng-container *ngIf="sample.annotation_path.length > 0">
                <button class="btn btn-sm btn-solid-icon" style=""[matMenuTriggerFor]="genoMenu" [matMenuTriggerData]="{sample: sample}">
                  <i class="fa fa-folder fa-5" style="line-height: inherit;"></i>
                </button>
            </ng-container>
            <ng-container *ngIf="sample.annotation_path.length === 0">
              NA
            </ng-container>
          </mat-cell>
      </ng-container>

       <ng-container matColumnDef="annotation_method">
          <mat-header-cell *matHeaderCellDef mwlResizable [enableGhostResize]="true" (resizeEnd)="onResizeEnd($event, 'annotation_method')"
     [resizeEdges]="{bottom: false, right: true, top: false, left: true}">
            Annotation Method
           <app-filter #filterComponent="menuInOtherComponent" [columnName]="'annotation_method'" [filterMode]="filterModeEnum.TEXT_MODE" [clear$] = "clear$" [choices$]="dataSource.choices$" (predicateEmitter)="applyFilter($event)"></app-filter>
          </mat-header-cell>
          <mat-cell *matCellDef="let sample">
              {{sample.annotation_method}}
          </mat-cell>
      </ng-container>

       <ng-container matColumnDef="annotation_format">
          <mat-header-cell *matHeaderCellDef mwlResizable [enableGhostResize]="true" (resizeEnd)="onResizeEnd($event, 'annotation_format')"
     [resizeEdges]="{bottom: false, right: true, top: false, left: true}">
            Annotation Format
           <app-filter #filterComponent="menuInOtherComponent" [columnName]="'annotation_format'" [filterMode]="filterModeEnum.TEXT_MODE" [clear$] = "clear$" [choices$]="dataSource.choices$" (predicateEmitter)="applyFilter($event)"></app-filter>
          </mat-header-cell>
          <mat-cell *matCellDef="let sample">
              {{sample.annotation_format}}
          </mat-cell>
      </ng-container>

       <ng-container matColumnDef="annotation_reference">
          <mat-header-cell *matHeaderCellDef mwlResizable [enableGhostResize]="true" (resizeEnd)="onResizeEnd($event, 'annotation_reference')"
     [resizeEdges]="{bottom: false, right: true, top: false, left: true}">
            Annotation Ref
           <app-filter #filterComponent="menuInOtherComponent" [columnName]="'annotation_reference'" [filterMode]="filterModeEnum.TEXT_MODE" [clear$] = "clear$" [choices$]="dataSource.choices$" (predicateEmitter)="applyFilter($event)"></app-filter>
          </mat-header-cell>
          <mat-cell *matCellDef="let sample">
              {{sample.annotation_reference}}
          </mat-cell>
      </ng-container>

       <ng-container matColumnDef="study_name">
          <mat-header-cell *matHeaderCellDef mwlResizable [enableGhostResize]="true" (resizeEnd)="onResizeEnd($event, 'study_name')"
     [resizeEdges]="{bottom: false, right: true, top: false, left: true}">
            Study Name
           <app-filter #filterComponent="menuInOtherComponent" [columnName]="'study_name'" [filterMode]="filterModeEnum.TEXT_MODE" [clear$] = "clear$" [choices$]="dataSource.choices$" (predicateEmitter)="applyFilter($event)"></app-filter>
          </mat-header-cell>
          <mat-cell *matCellDef="let sample"  (click)="showInfo(sample)">{{sample.study_name}}</mat-cell>
      </ng-container>

       <ng-container matColumnDef="study_date">
          <mat-header-cell *matHeaderCellDef mwlResizable [enableGhostResize]="true" (resizeEnd)="onResizeEnd($event, 'study_date')"
     [resizeEdges]="{bottom: false, right: true, top: false, left: true}">
            Study Date
           <app-filter #filterComponent="menuInOtherComponent" [columnName]="'study_date'" [filterMode]="filterModeEnum.TEXT_MODE" [clear$] = "clear$" [choices$]="dataSource.choices$" (predicateEmitter)="applyFilter($event)"></app-filter>
          </mat-header-cell>
          <mat-cell *matCellDef="let sample"  (click)="showInfo(sample)">{{sample.study_date}}</mat-cell>
      </ng-container>

       <ng-container matColumnDef="study_description">
          <mat-header-cell *matHeaderCellDef mwlResizable [enableGhostResize]="true" (resizeEnd)="onResizeEnd($event, 'study_description')"
     [resizeEdges]="{bottom: false, right: true, top: false, left: true}">
            Study Description
           <app-filter #filterComponent="menuInOtherComponent" [columnName]="'study_description'" [filterMode]="filterModeEnum.TEXT_MODE" [clear$] = "clear$" [choices$]="dataSource.choices$" (predicateEmitter)="applyFilter($event)"></app-filter>
          </mat-header-cell>
          <mat-cell *matCellDef="let sample"  (click)="showInfo(sample)">{{sample.study_description}}</mat-cell>
      </ng-container>

       <ng-container matColumnDef="institute">
          <mat-header-cell *matHeaderCellDef mwlResizable [enableGhostResize]="true" (resizeEnd)="onResizeEnd($event, 'institute')"
     [resizeEdges]="{bottom: false, right: true, top: false, left: true}">
            Institute
           <app-filter #filterComponent="menuInOtherComponent" [columnName]="'institute'" [filterMode]="filterModeEnum.TEXT_MODE" [clear$] = "clear$" [choices$]="dataSource.choices$" (predicateEmitter)="applyFilter($event)"></app-filter>
          </mat-header-cell>
          <mat-cell *matCellDef="let sample"  (click)="showInfo(sample)">{{sample.institute}}</mat-cell>
      </ng-container>

       <ng-container matColumnDef="researcher">
          <mat-header-cell *matHeaderCellDef mwlResizable [enableGhostResize]="true" (resizeEnd)="onResizeEnd($event, 'researcher')"
     [resizeEdges]="{bottom: false, right: true, top: false, left: true}">
            Researcher
           <app-filter #filterComponent="menuInOtherComponent" [columnName]="'researcher'" [filterMode]="filterModeEnum.TEXT_MODE" [clear$] = "clear$" [choices$]="dataSource.choices$" (predicateEmitter)="applyFilter($event)"></app-filter>
          </mat-header-cell>
          <mat-cell *matCellDef="let sample"  (click)="showInfo(sample)">{{sample.researcher}}</mat-cell>
      </ng-container>

       <ng-container matColumnDef="reference">
          <mat-header-cell *matHeaderCellDef mwlResizable class="small-col" [enableGhostResize]="true" (resizeEnd)="onResizeEnd($event, 'reference')"
     [resizeEdges]="{bottom: false, right: true, top: false, left: true}">
            Reference
           <app-filter #filterComponent="menuInOtherComponent" [columnName]="'reference'" [filterMode]="filterModeEnum.TEXT_MODE" [clear$] = "clear$" [choices$]="dataSource.choices$" (predicateEmitter)="applyFilter($event)"></app-filter>
          </mat-header-cell>
          <mat-cell *matCellDef="let sample" class="small-col">
            <ng-container *ngIf="sample.reference.startsWith('http')">
              <a href={{sample.reference}}><i class="fa fa-external-link" style="line-height: inherit;"></i></a>
            </ng-container>
            <ng-container *ngIf="!sample.reference.startsWith('http')">
              {{sample.reference}}
            </ng-container>
          </mat-cell>
      </ng-container>

       <ng-container matColumnDef="contact">
          <mat-header-cell *matHeaderCellDef mwlResizable [enableGhostResize]="true" (resizeEnd)="onResizeEnd($event, 'contact')"
     [resizeEdges]="{bottom: false, right: true, top: false, left: true}">
            Contact
           <app-filter #filterComponent="menuInOtherComponent" [columnName]="'contact'" [filterMode]="filterModeEnum.TEXT_MODE" [clear$] = "clear$" [choices$]="dataSource.choices$" (predicateEmitter)="applyFilter($event)"></app-filter>
          </mat-header-cell>
          <mat-cell *matCellDef="let sample"  (click)="showInfo(sample)">{{sample.contact}}</mat-cell>
      </ng-container>

       <ng-container matColumnDef="dataset">
          <mat-header-cell *matHeaderCellDef mwlResizable [enableGhostResize]="true" (resizeEnd)="onResizeEnd($event, 'dataset')"
     [resizeEdges]="{bottom: false, right: true, top: false, left: true}">
            Dataset
           <app-filter #filterComponent="menuInOtherComponent" [columnName]="'dataset'" [filterMode]="filterModeEnum.TEXT_MODE" [clear$] = "clear$" [choices$]="dataSource.choices$" (predicateEmitter)="applyFilter($event)"></app-filter>
          </mat-header-cell>
          <mat-cell *matCellDef="let sample"  (click)="showInfo(sample)">{{sample.dataset}}</mat-cell>
      </ng-container>

      <mat-header-row *matHeaderRowDef="displayedColumns; sticky: true "></mat-header-row>

      <mat-row *matRowDef="let row; columns: displayedColumns"></mat-row>

    </mat-table>
    </div>
</div>


<mat-menu #genoMenu="matMenu" xPosition="before" class="menu-overflow-hidden">
  <div  (click) = "$event.stopPropagation()">
    <ng-template matMenuContent let-sample="sample">
      <div class="container">
        <div class="row ml-1 mr-2">
          <b>{{sample.name}}</b>
        </div>
        <ng-container *ngIf="sample.annotation_method=='IGenotyper'">
          <div class="row ml-1 mr-2 mb-1">
            IGenotyper Report
          </div>
          <div class="row ml-4 mr-2 mb-0 align-middle">
            Genotype Analysis<span>&nbsp;&nbsp;</span><a href="{{sample.annotation_path}}" target="_blank"><i class="fa fa-desktop" style="line-height: inherit;"></i></a>
          </div>
          <div class="row ml-4 mr-2 mb-1">
            Haplotype<span>&nbsp;&nbsp;</span>
            <a href="{{sample.hap_report}}" target="_blank"><i class="fa fa-desktop" style="line-height: inherit;"></i></a>
            <span>&nbsp;&nbsp;</span>
            <a href="{{sample.hap_report.encodeURI}}" download="{{sample.name + '_haplotype.tab'}}"><i class="fa fa-save" style="line-height: inherit;"></i></a>
          </div>
        </ng-container>
        <ng-container *ngIf="sample.annotation_method=='VDJbase'">
          <div class="row ml-2 mr-2 mb-1">
            VDJbase Annotation Report
          </div>
          <div class="row ml-4 mr-2 mb-0 align-middle">
            Features<span>&nbsp;&nbsp;</span><a href="{{sample.annotation_path}}" target="_blank"><i class="fa fa-save" style="line-height: inherit;"></i></a>
          </div>
          <div class="row ml-4 mr-2 mb-1">
            Documentation<span>&nbsp;&nbsp;</span>
            <a href="{{sample.annotation_reference}}" target="_blank"><i class="fa fa-desktop" style="line-height: inherit;"></i></a>
          </div>
        </ng-container>
      </div>
    </ng-template>
  </div>
</mat-menu>

<mat-menu #downloadMenu="matMenu" xPosition="before" class="menu-overflow-hidden">
  <ng-template matMenuContent>
    <div class="container">
      <div class="row ml-1 mr-2">
        <b>Download data for selected samples</b>
      </div>
      <div class="row ml-4 mr-2 mb-0 align-middle">
        Sample info (csv)
          <span>&nbsp;&nbsp;</span>
          <button class="btn btn-sm btn-solid-icon addr" (click)="sendReportRequest('download_gen_data', 'csv', {type:'Sample info (CSV)'})">
            <i class="fa fa-file-pdf-o" style="line-height: inherit;" ></i> </button>
      </div>
      <div class="row ml-4 mr-2 mb-0 align-middle">
        Sample data (zip)
          <span>&nbsp;&nbsp;</span>
          <button class="btn btn-sm btn-solid-icon addr" (click)="sendReportRequest('download_gen_data', 'zip', {type:'Sample files (ZIP)'})">
            <i class="fa fa-file-zip-o" style="line-height: inherit;" ></i> </button>
      </div>
    </div>
  </ng-template>
</mat-menu>

